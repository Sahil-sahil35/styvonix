---
import Layout from "../../layouts/Layout.astro";
import { client, urlFor } from "../../lib/sanityClient";

// Make this page fully static at build time
export const prerender = true;

// Build every /product/[slug] path from Sanity
export async function getStaticPaths() {
  const query = `*[_type == "product" && defined(slug.current)]{ "slug": slug.current }`;
  const products = await client.fetch(query);
  return products.map((p) => ({
    params: { slug: p.slug },
  }));
}

const { slug } = Astro.params;
const productQuery = `*[_type == "product" && slug.current == $slug][0]`;
const allProductsQuery = `*[_type == "product"]`;

const product = await client.fetch(productQuery, { slug });
const allProducts = await client.fetch(allProductsQuery);

// Price formatting (mirrors your DOM logic)
function renderPrice(p) {
  if (p.negotiable) {
    return `<span class="negotiable-text">Negotiable</span>`;
  }
  if (p.salePrice) {
    const base = Number(p.price ?? 0).toFixed(2);
    const sale = Number(p.salePrice ?? 0).toFixed(2);
    return `<span class="original">₹${base}</span> <span class="sale">₹${sale}</span>`;
  }
  const base = Number(p.price ?? 0).toFixed(2);
  return `₹${base}`;
}

const isInStock = (product?.stock ?? 0) > 0;
const reviewCount = product?.reviewCount ?? 0;

// Similar products: share a category, exclude self; fallback to random
const currentCats = Array.isArray(product.category) ? product.category : [product.category].filter(Boolean);
let similar = allProducts
  .filter((p) => p.id !== product.id)
  .filter((p) => {
    const cats = Array.isArray(p.category) ? p.category : [p.category].filter(Boolean);
    return currentCats.length === 0 ? true : cats.some((c) => currentCats.includes(c));
  })
  .slice(0, 6);

if (similar.length === 0) {
  similar = allProducts.filter((p) => p.id !== product.id).slice(0, 6);
}

// Calculator FAB should show only for Filter Media
const isFilterMedia = Array.isArray(product.category)
  ? product.category.some((c) => String(c).toLowerCase() === "filter media")
  : String(product.category || "").toLowerCase() === "filter media";

// Safe helpers
const firstImage = Array.isArray(product.images) && product.images.length ? urlFor(product.images[0]).url() : "";
const images = Array.isArray(product.images) ? product.images.map(image => urlFor(image).url()) : [];
const specsEntries = product.specs ? Object.entries(product.specs) : [];
const documents = Array.isArray(product.documents) ? product.documents : [];
const tags = Array.isArray(product.tags) ? product.tags : [];
---

<Layout
  title={`${product.name} — Styvonix Future Pvt. Ltd.`}
  description={product.description}
  keywords="product details, water filter specifications, filter media details, activated carbon specs, technical documentation"
>
  <!-- Product Hero -->
  <section class="product-hero">
    <div class="product-hero-bg"></div>
    <div class="product-hero-overlay"></div>
    <div class="product-hero-content">
      <h1 id="heroProductTitle">{product.name}</h1>
      <p class="product-hero-subtitle" id="heroProductDesc">{product.description}</p>
      <div class="breadcrumbs">
        <a href="/">Home</a><span class="separator">/</span><a href="/listing">Shop</a><span class="separator">/</span><span id="productNameBreadcrumb">{product.name}</span>
      </div>
    </div>
  </section>

  <!-- Product Detail Section -->
  <div class="container">
    <div class="product-detail">
      <div class="product-gallery">
        <div class="thumbnail-container" id="thumbnails">
          {images.map((img, i) => (
            <img src={img} alt={`${product.name} thumbnail ${i + 1}`} class={`thumbnail${i === 0 ? " active" : ""}`} />
          ))}
          {product.videoUrl && (
            <div class="video-thumbnail-wrapper">
              <img src={firstImage} alt="Product video thumbnail" class="thumbnail" />
              <div class="video-play-icon"></div>
            </div>
          )}
        </div>

        <div class="main-image-container" id="mainMediaContainer">
          {product.videoUrl ? (
            <img src={firstImage} alt={product.name} class="main-image" id="mainImage" />
          ) : (
            <img src={firstImage} alt={product.name} class="main-image" id="mainImage" />
          )}
        </div>
      </div>

      <div class="product-info">
        <h1 class="product-title" id="productTitle">{product.name}</h1>

        <div class="product-meta">
          <div class="product-rating">
            <span class="rating-stars">★★★★★</span>
            <span class="review-count" id="reviewCount">({reviewCount} reviews)</span>
          </div>
          <div class={`stock-status ${isInStock ? "in-stock" : "out-of-stock"}`} id="stockStatus">
            {isInStock ? "In Stock" : "Out of Stock"}
          </div>
        </div>

        <div class="product-price" id="productPrice" set:html={renderPrice(product)} />

        <p class="product-description" id="productDescription">
          {product.detailedDescription || product.description}
        </p>

        <div class="product-actions">
          <button class="btn-outline-product-detail" id="contactBtn">Contact Us</button>
          <button class="btn-solid-product-detail" id="addToCartBtn" disabled={!isInStock}>{isInStock ? "Add to Cart" : "Out of Stock"}</button>
        </div>

        <div class="product-tags-container">
          <div id="productTags" class="product-tags">
            {tags.map((t) => (
              <a class="filter-chip" href={`/tag/${t.toLowerCase().replace(/\s+/g, '-')}`}>{t}</a>
            ))}
          </div>
        </div>

        <div class="product-specs">
          <h3>Specifications</h3>
          <table class="specs-table" id="specsTable">
            <tbody>
              {specsEntries.length
                ? specsEntries.map(([k, v]) => {
                    const label = k.replace(/([A-Z])/g, " $1").replace(/^./, (s) => s.toUpperCase());
                    const val = Array.isArray(v) ? v.join(", ") : String(v);
                    return (
                      <tr>
                        <th>{label}</th>
                        <td>{val}</td>
                      </tr>
                    );
                  })
                : (
                  <tr><td colspan="2">No specifications available</td></tr>
                )}
            </tbody>
          </table>
        </div>

        <div class="product-documents">
          <h3>Documents</h3>
          <div class="documents-list" id="documentsList">
            {documents.length
              ? documents.map((d) => <a href={d.url} target="_blank">{d.name}</a>)
              : <p>No documents available</p>}
          </div>
        </div>
      </div>
    </div>

    <!-- Similar Products -->
    <section class="section products-section" id="similarProducts">
      <h2 class="section-title">Similar Products</h2>
      <div class="products-container">
        <div class="products-scroll" id="productsScroll">
          {similar.map((sp) => (
            <div class="product-card">
              <div class="product-image">
                <img src={urlFor(sp.images[0]).url()} alt={sp.name} />
              </div>
              <div class="product-content">
                <h3 class="product-name">{sp.name}</h3>
                <p class="product-desc">{sp.description}</p>
                <div class="product-buttons">
                  <a href={`/product/${sp.slug.current}`} class="btn-outline-listing">View Details</a>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">Added to temporary cart — clears when you leave</div>

  <!-- Calculator Modal -->
  <div class="modal" id="calculatorModal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <div class="calculator-modal-layout">
        <div class="calculator-main">
          <h2 id="calculatorTitle">Media Calculator</h2>
          <div class="form-group">
            <label for="calculatorUnit">Measurement Unit</label>
            <select id="calculatorUnit">
              <option value="mm">Millimeter (mm)</option>
              <option value="cm">Centimeter (cm)</option>
              <option value="m">Meter (m)</option>
              <option value="in">Inches (in)</option>
            </select>
          </div>
          <div id="calculatorBody"></div>
        </div>
        <div class="calculator-promo">
          <h2>Water Treatment Engineer App</h2>
          <p>Whether its Media, Resin Or something else</p>
          <p>Get precise calculations on the go with our dedicated mobile app.</p>
          <a href="https://play.google.com/store/apps/details?id=com.sahil.tankmediacalculator&pcampaignid=web_share" target="_blank" class="promo-download-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 22v-20l18 10-18 10z"/></svg>
            <span>Download Now</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Buttons Container -->
  <div class="fab-container">
    <div id="calculatorFabContainer" class="calculator-fab-container" style={`display: ${isFilterMedia ? "block" : "none"}`}>
      <select id="calculatorShapeSelector" class="fab-shape-selector">
        <option value="" disabled selected>Select Shape</option>
        <option value="cylindrical">Cylindrical</option>
        <option value="cube">Cube</option>
        <option value="cuboid">Cuboid</option>
      </select>
      <button id="calculateMediaBtn" class="fab-btn" title="Calculate Media">Calculate Media</button>
    </div>
    <button id="backToTopBtn" title="Go to top">▲</button>
  </div>

  <!-- Tiny inline scripts for thumbnails & video toggle; no data fetching -->
  <script is:inline>
    (function () {
      const main = document.getElementById('mainMediaContainer');
      const thumbs = document.querySelectorAll('#thumbnails .thumbnail');
      const videoWrapper = document.querySelector('.video-thumbnail-wrapper');
      function showImage(src) { main.innerHTML = '<img src="' + src + '" class="main-image" id="mainImage" alt="Product image">'; }
      function showVideo(src) { main.innerHTML = '<video src="' + src + '" class="main-image" controls autoplay playsinline loop></video>'; }
      thumbs.forEach((t) => {
        t.addEventListener('click', () => {
          showImage(t.getAttribute('src'));
          document.querySelectorAll('.thumbnail, .video-thumbnail-wrapper').forEach(el => el.classList.remove('active'));
          t.classList.add('active');
        });
      });
      if (videoWrapper) {
        videoWrapper.addEventListener('click', () => {
          showVideo({product:product}.product.videoUrl);
          document.querySelectorAll('.thumbnail, .video-thumbnail-wrapper').forEach(el => el.classList.remove('active'));
          videoWrapper.classList.add('active');
        });
      }
    })();
  </script>

  <script define:vars={{ product }}>
    function setupActionButtons(product) {
      const contactBtn = document.getElementById('contactBtn');
      if (contactBtn) {
          contactBtn.addEventListener('click', () => openContactModal(product.name));
      }

      const addToCartBtn = document.getElementById('addToCartBtn');
      if (addToCartBtn) {
        // Remove old listeners to prevent duplicates if this script ever runs twice
        const newBtn = addToCartBtn.cloneNode(true);
        addToCartBtn.parentNode.replaceChild(newBtn, addToCartBtn);
        
        if (product.stock > 0) {
            newBtn.disabled = false;
            newBtn.textContent = 'Add to Cart';
            newBtn.addEventListener('click', () => addToCart(product.id, newBtn));
        } else {
            newBtn.disabled = true;
            newBtn.textContent = 'Out of Stock';
        }
      }
    }
    // Run the function after the DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setupActionButtons(product));
    } else {
        setupActionButtons(product);
    }
  </script>

  <!-- If you have calculator.js (non-fetch utilities), keep it. Avoid product_details.js since we SSR everything. -->
  <script src="/js/calculator.js" is:inline></script>
</Layout>
